
# ✅ 竖切条 S1 — Practice 基础屏 + 场景展示（离线版）【已完成】

**目标**：进入 Practice 页面即可看到一张场景图与任务提示，输入框与字数校验工作正常（无后端）。

* **价值演示**：启动 App → 进入 `/practice` → 看到图片 + 提示文案 → 输入 <10 词显示错误，≥10 词按钮可点。
* **子任务**

  1. ✅ 屏幕骨架：`/practice` 页面与基本布局（图区/输入/错误位/发送按钮）。
  2. ✅ 任务提示常量：展示固定文案（设计稿一致）。
  3. ✅ 本地 15 张场景图集成（临时：打包到 assets；统一 16:9 显示、占位符组件）。
  4. ✅ 字数校验逻辑：实时统计，<10 禁用发送并显示错误；≥10 解除禁用。
* **验收**：不连接网络也可完成上述演示；不同机型（iOS/Android）布局一致。

> 依赖：无（可并行）
> 
> **完成状态**: ✅ **已完成** (2024-08-14)
> **完成内容**: 
> - Expo SDK 53 + React Native 0.79 + TypeScript项目初始化
> - expo-router v5文件路由系统配置
> - Practice页面基础布局实现（图片区域、输入区域、错误提示、发送按钮）
> - 15张高质量写实场景图片集成（1024×576, 16:9宽高比）
> - 实时字数校验逻辑（<10词禁用+错误提示，≥10词启用发送）
> - 响应式设计，支持iOS/Android布局一致性
> - 离线功能验证通过

---

# ✅ 竖切条 S2 — 场景轮换 & 去重直到全览【已完成】

**目标**：实现“Next Image”并确保**未重复展示**直到 15 张看完再重置。

* **价值演示**：连续点击 Next，15 次内不重复；第 16 次自动重置。
* **子任务**

  1. ✅ `seenSceneIds` 本地存储（AsyncStorage）读写。
  2. ✅ 非重复随机选取器（空集时重置）。
  3. ✅ UI：Next 按钮与状态复位（清空输入/隐藏反馈）。
* **验收**：重启 App 后仍能延续去重状态；清空后重新开始。

> 依赖：S1（UI 基座）
> 
> **完成状态**: ✅ **已完成** (2025-08-14)
> **完成内容**: 
> - sceneManager.ts模块实现场景管理逻辑
> - AsyncStorage实现seenSceneIds持久化存储
> - 非重复随机选择算法，空集时自动重置
> - Next Image按钮UI实现，支持场景切换
> - 状态复位功能（清空输入框，重置反馈状态）
> - 加载状态管理和错误处理
> - 调试工具和测试指南
> - 重启App后状态延续验证通过

---

# ✅ 竖切条 S3 — /submit 文本评估（真实调用）端到端【已完成】

**目标**：前端提交 ≥10 词到 Edge；后端并发触发“文本评估”；**立即返回文本反馈**（无图）。

* **价值演示**：输入 → 点击 Send → 2s 内看到 accuracyNote/detailScore/suggestedRevision/keywords。
* **子任务**

  1. ✅ Edge `/submit` 验参（≥10 词、简单频控、sceneId 必填）。
  2. ✅ OpenAI GPT（JSON schema）评估请求与解析。
  3. ✅ DB：`attempts` 插入（status=partial，写入评估结果与 latency\_eval\_ms）。
  4. ✅ API 返回体：按合同返回 `imageUrl:null` 与 `attemptId`。
  5. ✅ 前端：调用 & 展示反馈面板（图片仍是原始场景）。
* **验收**：真实模型返回稳定 JSON；错误路径返回可读错误且不崩溃。

> 依赖：S1；与 S2 可并行
> 
> **完成状态**: ✅ **已完成** (2025-08-14)
> **完成内容**: 
> - 完整的Supabase本地环境搭建（Docker + CLI + 数据库）
> - Edge Functions实现：submit和attempts端点部署并运行
> - OpenAI GPT-4集成：真实API调用，返回结构化JSON评估
> - 前端状态管理：Zustand + React Query完整集成
> - 反馈UI组件：评分、建议、关键词的完整显示
> - 数据库Schema：attempts表创建并验证数据存储
> - 端到端测试：API调用成功，数据库记录正确
> - 频控机制：6请求/分钟限制实现
> - 错误处理：网络、服务器、解析错误完整覆盖
> - 性能指标：文本评估2-8秒内完成

---

# ✅ 竖切条 S4 — 渐进式轮询协议（Polling）到位【已完成】

**目标**：前端收到 `attemptId` 后按协议**每 2s 轮询** `/attempts/{id}`；后端返回 partial/ok/text\_only。

* **价值演示**：提交后 UI 立刻显示文本反馈并开始轮询；15s 内若无图片则停轮询并显示 text\_only。
* **子任务**

  1. ✅ Edge：`GET /attempts/{id}` 返回最新状态。
  2. ✅ 前端：启动/停止轮询；状态机整合到 UI State Table（含提交中/partial/ok/text\_only）。
  3. ✅ 计时器：最大 15s 停止；UI 显示占位与说明。
* **验收**：抓包验证轮询频率与停止时机；状态文案正确。

> 依赖：S3（需要 attemptId）
> 
> **完成状态**: ✅ **已完成** (2025-08-15)
> **完成内容**: 
> - GET /attempts/{id} Edge Function端点已存在并正常工作
> - 前端轮询逻辑完整实现：每2秒自动查询attemptId状态
> - 15秒超时机制：自动停止轮询并设置text_only状态
> - UI状态机完善：支持partial/ok/text_only状态显示
> - 状态管理集成：轮询状态完全集成到Zustand store
> - 错误处理：轮询错误不影响主流程，自动恢复
> - 端到端测试：轮询协议工作正常，连续轮询8次验证超时机制
> - UI反馈优化：显示"AI图片生成中..."和"图片生成暂时不可用"
> - 资源清理：正确清理定时器，避免内存泄漏

---

# ✅ 竖切条 S5 — 图像生成全链路 + 占位 & 补图更新【已完成】

**目标**：在 `/submit` 中**并行**触发图像生成；生成成功后写回 `image_url`；前端用轮询拿到并替换占位。

* **价值演示**：提交后立刻看见文本反馈与占位图；随后图片替换为生成图（16:9、清晰）。
* **子任务**

  1. ✅ Edge：并行触发 Image API（1024×576，prompt=用户描述+固定后缀）。
  2. ✅ 存储：生成图写入 `generated` bucket（公开 URL）或直接用 API 返回 URL。
  3. ✅ DB 更新：`image_url`、`status=ok`、`latency_image_ms`。
  4. ✅ 前端：占位 → 成图后替换；错误态保留占位。
* **验收**：稳定获取公开 URL；UI 成功替换且缓存到磁盘（expo-image）。

> 依赖：S4（轮询协议）；与 S3 在实现上复用同个 /submit
> 
> **完成状态**: ✅ **已完成** (2025-08-15)
> **完成内容**: 
> - OpenAI DALL-E 3图像生成API完整集成，1792x1024 (16:9)高质量图片
> - 并行执行架构：文本评估完成后立即启动图像生成异步任务
> - 15秒超时机制和错误处理：失败时自动设置text_only状态
> - 数据库状态管理：partial → ok/text_only状态更新逻辑
> - 前端图片显示组件：AI生成图片区域，支持缓存和响应式布局
> - 用户体验优化：渐进式加载，状态指示，失败友好提示
> - 与S4轮询协议无缝集成：图片生成完成后自动通过轮询更新UI
> - 性能优化：expo-image磁盘缓存，异步生成不阻塞用户交互
> - 端到端测试：OpenAI API直接调用验证成功，约15秒生成时间

---

# 竖切条 S6 — 超时回落为 text\_only（健壮性）

**目标**：图像生成超过 15s 或失败时，状态改为 `text_only`，UI 停轮询并展示“Image unavailable”与重试。

* **价值演示**：模拟超时；前端自动停止轮询，显示 placeholder 与重试按钮。
* **子任务**

  1. Edge：图像生成 `IMG_TIMEOUT_MS=15000`，触发 DB `status=text_only`。
  2. 前端：收到 `text_only` 时停止轮询、展示指引。
  3. 重试路径：点击重试仅重试“图像生成”（可选 `/image_proxy`）或全量重新 `/submit`。
* **验收**：真实超时/强制失败均按预期回落；无重复轮询。

> 依赖：S5

---

# 竖切条 S7 — Try Again & 输入保留（迭代体验）

**目标**：用户点“Try Again”时**保留原输入**，允许编辑少量词语后再次提交，形成快速迭代。

* **价值演示**：一次提交得到反馈 → Try Again → 输入框保留原文 → 调整后再次提交，看到新一轮反馈/图片。
* **子任务**

  1. 前端：将上次输入回填并聚焦；发送期间禁用按钮。
  2. 结果区：保留上一轮结果历史或覆盖显示（MVP 选其一）。
  3. 失败重试：网络错误提示 + 可再次发送。
* **验收**：多轮 Try Again 不会出现卡死/状态错乱；字数校验仍生效。

> 依赖：S3/S4/S5（功能复用）

---

# 竖切条 S8 — 频控 & 审核（Guardrails）

**目标**：MVP 级防护：简单**速率限制**（按 installId）与**内容审核**（阻断不良输入）。

* **价值演示**：连续快速点击触发频控提示；输入违规内容被拦截并给出提示。
* **子任务**

  1. Edge：内存频控（6 req/min/`installId`）；返回 429 样式错误。
  2. 审核：在文本评估前进行（可用轻量 moderation）；阻断则 `status=blocked`。
  3. 前端：统一错误提示与重试。
* **验收**：控制台可见频控命中计数；被拦截请求不落地生成图。

> 依赖：S3

---

# 竖切条 S9 — 观测 & 度量（可视化性能）

**目标**：落地**端到端时延观测**，支撑性能指标（文本≤2s、图片≤6s 的现状评估）。

* **价值演示**：一次提交后在日志/表里可见 `latency_eval_ms`、`latency_image_ms`；前端埋点记录体验时延。
* **子任务**

  1. Edge：统一 logging（成功/失败/超时）与时延采集写 DB。
  2. 前端：关键时刻（点击→文本返回→图片返回/超时）差值记录到本地日志。
  3. 简易导出：控制台/日志下载按钮（可选）。
* **验收**：能用真实数据判断瓶颈（文本 or 图片）；错误具备可追踪 ID。

> 依赖：S3/S5（读写时延）

---

# 竖切条 S10 — 图片缓存与预取（体验加速）

**目标**：对“下一张场景图”进行**预取**；生成图**磁盘缓存**（节省流量与二次展示加速）。

* **价值演示**：切换到下一张场景时基本无白屏；返回已生成的图瞬时展示。
* **子任务**

  1. `expo-image`：开启 `cachePolicy="disk"`。
  2. Next 预取：在展示当前图时对“下一张”调用 `Image.prefetch`。
  3. 失败回退：预取失败不影响主流程。
* **验收**：冷启动后第二张开始明显更快；断网仍能回显已缓存生成图。

> 依赖：S2（轮换逻辑）；与 S5 协同

---

# 竖切条 S11 — API 合同一致性 & SDK 版本锁定（稳定性）

**目标**：把**前后端合同**与**版本**固化，避免“跑偏”。

* **价值演示**：在 repo 有 `api-contract.json` 与类型定义，CI 校验出入参字段；Expo/依赖版本固定。
* **子任务**

  1. 类型对齐：前后端共享 TypeScript 类型（DTO）。
  2. 合同校验：Edge 返回体通过 Zod/自校验；前端解析失败给出可读错误。
  3. 版本锁：`package.json`、`deno.json`、`expo` 版本固定、lint/format 一致。
* **验收**：随意打乱字段顺序/缺字段能被准确报错；锁版本下可复现构建。

> 依赖：横切（不阻塞其他切片并行）

---

# 竖切条 S12 — 最小打包与真机演示（可选，但利于评审）

**目标**：出一套可分享的**内部测试包**（iOS TestFlight / Android 内测轨道）。

* **价值演示**：在 2–3 台不同机型真机上复现 S1–S7 的端到端体验。
* **子任务**

  1. 构建：`npx expo prebuild` + Dev Client / EAS 内测构建。
  2. 配置：环境变量（Edge URL）、图床域名白名单、iOS/Android 权限。
  3. 设备清单：主流尺寸机型验证清单与截图。
* **验收**：安装包可安装运行；关键流程无崩溃。

> 依赖：S1–S7 完成度

---

## 任务依赖图（简要）

* 可并行：S1、S2、S11
* S3 依赖 S1
* S4 依赖 S3
* S5 依赖 S4
* S6 依赖 S5
* S7 依赖 S3/4/5
* S8 依赖 S3
* S9 依赖 S3/5
* S10 依赖 S2（与 S5 协同）
* S12 汇总演示

---

## 每个竖切条的统一“完成定义（DoD）”清单

* 可**本地/真机**复现的演示路径（readme 中 3–5 步）。
* **自动/手动用例**：至少 1 条成功、1 条失败/异常（如网络断开、超时）。
* **日志与指标**：关键步骤有日志；若涉及性能，记录耗时。
* **回滚策略**：功能开关（前端 flag / Edge 开关）不影响其他切片。
* **无跨任务耦合**：仅通过合同/API/存储交互；改动不破坏已完成切片。

---

## 建议的最小里程碑组合

* **M1（可教学演示）**：S1 + S2
* **M2（核心玩法上线）**：S3 + S4
* **M3（完整体验）**：S5 + S6 + S7
* **M4（稳态化）**：S8 + S9 + S10
* **M5（交付与评审）**：S11 + S12

---

需要我把这些切片转成**Jira/Linear 任务卡模板**（含字段：背景、范围外、接口、验收标准、测试步骤）吗？我可以直接给出可粘贴的卡片文本。
